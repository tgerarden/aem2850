---
title: "Mapping data to graphics and amounts"
author: "Todd Gerarden"
output:
  xaringan::moon_reader:
    lib_dir: "libs"
    css: ["xaringan-themer.css", "css/tdg-slides.css"]
#    css: ['default', 'metropolis', 'metropolis-fonts']
    seal: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      slideNumberFormat: "%current%"
      ratio: "16:9"
      navigation:
        scroll: false
      # beforeInit: "libs/offline-mathjax.js"
editor_options: 
  chunk_output_type: console
---

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_mono_accent(base_color = "#B31B1B",
                  text_font_size = "1.4rem")
xaringanExtra::use_xaringan_extra(c("tile_view"))
```

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(warning = FALSE, message = FALSE, 
                      #cache = TRUE,
                      fig.retina = 3, fig.align = "center",
                      fig.width=14, fig.height=7)
```

```{r packages-data, include=FALSE}
library(tidyverse)
library(ggthemes)
library(gapminder)
```

class: center middle main-title section-title-4

# Mapping data to graphics and amounts

.class-info[

**Week 7**

AEM 2850 / 5850 : R for Business Analytics<br>
Cornell Dyson<br>
Spring 2025

Acknowledgements: 
[Andrew Heiss](https://datavizm20.classes.andrewheiss.com), 
[Claus Wilke](https://wilkelab.org/SDS375/)
<!-- [Grant McDermott](https://github.com/uo-ec607/lectures), -->
<!-- [Jenny Bryan](https://stat545.com/join-cheatsheet.html), -->
<!-- [Allison Horst](https://github.com/allisonhorst/stats-illustrations) -->

]

---

# Announcements

This week marks the start of the data visualization component of this course

Next lab is due Monday

We will provide details on the group project in the next few weeks

Questions before we get started?


---

# Plan for this week

.pull-left[
### Tuesday
  - [Course progress](#progress)
  - [Prologue](#prologue)
  - [Data, aesthetics, <br> & the grammar of graphics](#grammar-of-graphics)
  - [Grammatical layers](#grammatical-layers)
  - [example-07-1](#example-1)
  <!-- - [Prelim 1](#example-1) -->
  - [Reference: Putting it all together](#putting-it-together)
  - [Reference: Additional layers](#additional-layers)
]

.pull-right[
### Thursday
  - [Prologue](#prologue-2)
  - [Amounts](#amounts)
  - [Plotting amounts using ggplot](#plotting-amounts)
  - [example-07-2](#example-2)
]

---
class: inverse, center, middle
name: progress

# Course progress

---

# Course objectives reminder

1. Develop basic proficiency in `R` programming
2. Understand data structures and manipulation
3. Describe effective techniques for data visualization and communication
4. Construct effective data visualizations
5. Utilize course concepts and tools for business applications

---

# Where we've been

1. **Develop basic proficiency in `R` programming**
2. **Understand data structures and manipulation**
3. Describe effective techniques for data visualization and communication
4. Construct effective data visualizations
5. Utilize course concepts and tools for business applications

---

# Where we're going next

1. Develop basic proficiency in `R` programming
2. Understand data structures and manipulation
3. **Describe effective techniques for data visualization and communication**
4. **Construct effective data visualizations**
5. Utilize course concepts and tools for business applications

---

# Schedule overview

#### Weeks 1-5: Programming Foundations

#### Weeks 7-10: Data Visualization Foundations

#### Weeks 11+: Special Topics (mix of programming and dataviz)

See [aem2850.toddgerarden.com/schedule](https://aem2850.toddgerarden.com/schedule/) for details


---
class: inverse, center, middle
name: prologue

# Prologue


---

# [Health and wealth](https://www.youtube.com/watch?v=jbkSRLYSojo)

```{r echo=FALSE, out.width='75%'}
knitr::include_graphics("img/07/gapminder-screenshot.png")
# click the link above to access the youtube
# could switch to use youtube html embed code to make the entire plot a link
```

???

Image source: [Gapminder](https://www.gapminder.org/tools/#$chart-type=bubbles)

[Video](https://www.youtube.com/watch?v=jbkSRLYSojo)


---
class: inverse, center, middle
name: grammar-of-graphics

# Data, aesthetics,<br>& the grammar of graphics

---

# Mapping data to aesthetics

.pull-left.center[

<figure>
  <img src="img/07/gg-book.jpg" alt="ZZZ" title="ZZZ" width="55%">
</figure>

]

.pull-right[

### Data

A column in a dataset

### Aesthetics

Visual properties of a graph

Position, shape, color, etc.

]

---

# Mapping data to aesthetics

.pull-left[
<table>
  <tr>
    <th class="cell-left">Data</th>
    <th class="cell-left">Aesthetic</th>
    <th class="cell-left">Geometry</th>
  </tr>
  <tr>
    <td class="cell-left">Wealth</td>
    <td class="cell-left">Position (x)</td>
    <td class="cell-left">Point</td>
  </tr>
  <tr>
    <td class="cell-left">Health</td>
    <td class="cell-left">Position (y)</td>
    <td class="cell-left">Point</td>
  </tr>
  <tr>
    <td class="cell-left">Continent</td>
    <td class="cell-left">Color</td>
    <td class="cell-left">Point</td>
  </tr>
  <tr>
    <td class="cell-left">Population</td>
    <td class="cell-left">Size</td>
    <td class="cell-left">Point</td>
  </tr>
</table>
]

.pull-right[
```{r echo=FALSE, out.width='100%'}
knitr::include_graphics("img/07/gapminder-screenshot.png")
```
]


---

# Barebones `ggplot2::ggplot()` template

```{r show-ggplot-template-0, eval=FALSE}
library(tidyverse) # tidyverse loads the package ggplot2
```

--

We need to specify data, aesthetic mapping, and geometry:
```{r show-ggplot-template-1, eval=FALSE}
ggplot(
  data = DATA,
  mapping = aes(AESTHETIC MAPPINGS)
) +
  GEOM_FUNCTION()
```

--

Or, in the context of a data wrangling pipeline:
```{r show-ggplot-template-2, eval=FALSE}
DATA |> 
  ... |> # intermediate data wrangling (optional)
  ggplot(aes(AESTHETIC MAPPINGS)) +
  GEOM_FUNCTION()
```

---

# Mapping from `gapminder` to aesthetics
```{r gapminder-data, echo=FALSE, warning=FALSE}
gapminder_2007 <- gapminder |> 
  filter(year == 2007) |> 
  select(country, continent, gdpPercap, lifeExp, pop)
```

```{r head-gapminder-mask-1, echo=FALSE}
gapminder_2007 |> 
  slice(1:2) |> 
  mutate_all(as.character) |> 
  bind_rows(tibble(country = "…", continent = "…", gdpPercap = "…", lifeExp = "…", pop = "…")) |> 
  knitr::kable(format = "html", align = "ccccc")
```

```{r gapminder-example-mask-1, eval=FALSE}
_________ |> #<<
  ggplot(aes(x = _________,
             y = _______,
             color = _________,
             size = ___)) +
  geom______() +
  scale_x_log10() + theme_classic(base_size = 20) # ignore this line for now
```

Let's fill in the blanks... how do we start?

---

# Mapping from `gapminder` to aesthetics
```{r head-gapminder-mask-2, echo=FALSE}
gapminder_2007 |> 
  slice(1:2) |> 
  mutate_all(as.character) |> 
  bind_rows(tibble(country = "…", continent = "…", gdpPercap = "…", lifeExp = "…", pop = "…")) |> 
  knitr::kable(format = "html", align = "ccccc")
```

```{r gapminder-example-mask-2, eval=FALSE}
gapminder |> 
  ggplot(aes(x = _________, #<<
             y = _______, #<<
             color = _________,
             size = ___)) +
  geom______() +
  scale_x_log10() + theme_classic(base_size = 20) # ignore this line for now
```

Let's fill in the blanks... what should we map to x? y?

---

# Mapping from `gapminder` to aesthetics
```{r head-gapminder-mask-3, echo=FALSE}
gapminder_2007 |> 
  slice(1:2) |> 
  mutate_all(as.character) |> 
  bind_rows(tibble(country = "…", continent = "…", gdpPercap = "…", lifeExp = "…", pop = "…")) |> 
  knitr::kable(format = "html", align = "ccccc")
```

```{r gapminder-example-mask-3, eval=FALSE}
gapminder |> 
  ggplot(aes(x = gdpPercap,
             y = lifeExp,
             color = _________, #<<
             size = ___)) + #<<
  geom______() +
  scale_x_log10() + theme_classic(base_size = 20) # ignore this line for now
```

Let's fill in the blanks... what should we map to color? size?

---

# Mapping from `gapminder` to aesthetics
```{r head-gapminder-mask-4, echo=FALSE}
gapminder_2007 |> 
  slice(1:2) |> 
  mutate_all(as.character) |> 
  bind_rows(tibble(country = "…", continent = "…", gdpPercap = "…", lifeExp = "…", pop = "…")) |> 
  knitr::kable(format = "html", align = "ccccc")
```

```{r gapminder-example-mask-4, eval=FALSE}
gapminder |> 
  ggplot(aes(x = gdpPercap,
             y = lifeExp,
             color = continent,
             size = pop)) +
  geom______() + #<<
  scale_x_log10() + theme_classic(base_size = 20) # ignore this line for now
```

Let's fill in the blanks... what geometry should we use?

---

# Mapping from `gapminder` to aesthetics
```{r head-gapminder, echo=FALSE}
gapminder_2007 |> 
  slice(1:2) |> 
  mutate_all(as.character) |> 
  bind_rows(tibble(country = "…", continent = "…", gdpPercap = "…", lifeExp = "…", pop = "…")) |> 
  knitr::kable(format = "html", align = "ccccc")
```

```{r gapminder-example, eval=FALSE}
gapminder |> 
  ggplot(aes(x = gdpPercap,
             y = lifeExp,
             color = continent,
             size = pop)) +
  geom_point() +
  scale_x_log10() + theme_classic(base_size = 20) # ignore this line for now
```

All done! Let's see what we get...

---

# Health and wealth

```{r show-basic-gapminder, echo=FALSE, fig.width=12, fig.height=5.5, out.width="100%"}
gapminder_2007 |> 
  ggplot(aes(x = gdpPercap,
             y = lifeExp,
             color = continent,
             size = pop)) +
  geom_point() +
  scale_x_log10() + theme_classic(base_size = 20)
# +
#   scale_size_continuous(range = c(1, 15),
#                         labels = scales::comma)
```

---
class: inverse, center, middle
name: grammatical-layers

# Grammatical layers

---

# Grammar components as layers

.pull-left[
So far we know about data, aesthetics, and geometries

Think of these components as **layers**

Add to foundational `ggplot()` with `+`


Why `+` and not `|>`?
> ggplot2 was written before the pipe was discovered


Treat the `+` the same as `|>`

]

.pull-right[

&nbsp;

![](img/07/ggplot-layers-short@4x.png)
]

???

Layer analogy borrowed from [Thomas Lin Pedersen](https://www.data-imaginist.com/) and his ["Drawing Anything with ggplot2" workshop](https://github.com/thomasp85/ggplot2_workshop).

Source for quote: [R4DS (2e)](https://r4ds.hadley.nz/workflow-style.html#ggplot2)

---

# Additional layers

.pull-left[
There are many other grammatical layers we can use to describe graphs!

We can sequentially add layers to the foundational `ggplot()` plot to create complex figures

We will primarily learn by doing, though this slide deck contains [a preview of additional layers](#additional-layers) in case you need some bedtime reading
]

.pull-right[
![](img/07/ggplot-layers@4x.png)
]


---

# A true grammar

.pull-left[
You have probably made graphics in Excel by searching through menus for a specific chart type, and then reshaping your data to work with it

With the grammar of graphics, we don't talk about specific chart **types**
]

.pull-right[
.center[
<figure>
  <img src="img/07/excel-chart-types.png" alt="Excel chart types" title="Excel chart types" width="85%">
</figure>
]
]

---

# A true grammar

.pull-left[
With the grammar of graphics, we talk about specific chart **elements**

- .small[Map a column to the x-axis, fill by a variable, `geom_col()` to get stacked bars]

- .small[Geometries can be interchangeable (e.g., `geom_violin()` and `geom_boxplot()`)]

This grammar is portable to other software like Tableau, which is [built on the grammar of graphics](https://www.tableau.com/about/blog/2015/4/getting-know-lee-wilkinson-tableaus-new-vp-statistics-38654)
]

.pull-right[
![](img/07/ggplot-layers@4x.png)
]

---
name: tidy-data

# Tidy data revisited

`ggplot()` is incredibly flexible

For `ggplot()` to work its magic, your data frame needs to be **tidy**

This requires a bit of upfront work, but it pays off

As you will see, we can make many different plots without modifying our data

---

```{r echo=FALSE, out.width='100%'}
knitr::include_graphics("img/07/tidydata_7.jpg")
```


---
class: inverse, center, middle
name: example-1

# example-07-1:<br>mapping-data-to-graphics-practice.R


---
class: inverse, center, middle
name: putting-it-together

# Putting it all together


---

# Putting it all together

In the example, we'll build a plot sequentially to see how each grammatical layer changes its appearance

The rest of this section presents that code and output in slide form

For illustrative purposes, let's use data on cars from the data frame `ggplot2::mpg`

```{r head-mpg, echo=FALSE}
mpg |> 
  filter(manufacturer=="volkswagen") |> 
  slice(1:2) |> 
  select(manufacturer, model, year, trans, displ, hwy, drv) |> 
  mutate_all(as.character) |> 
  bind_rows(tibble(manufacturer = "…", model = "…", year = "…", trans = "…", displ = "…", hwy = "…", drv = "…")) |> 
  knitr::kable(format = "html")
```

---

.left-code[
### Start with data and aesthetics

```{r mpg-layers-1, tidy=FALSE, message=FALSE, fig.show="hide", fig.dim=c(4.8, 5), out.width="100%"}
ggplot(data = mpg,                              #<<
       aes(x = displ, # engine displacement     #<<
           y = hwy, # highway mpg               #<<
           color = drv))  # type of drive train #<<
```
]

.right-plot[
![](`r knitr::fig_chunk("mpg-layers-1", "png")`)
]

---

.left-code[
### Add a point geom

```{r mpg-layers-2, tidy=FALSE, message=FALSE, fig.show="hide", fig.dim=c(4.8, 5), out.width="100%"}
ggplot(data = mpg,
       mapping = aes(x = displ,
                     y = hwy,
                     color = drv)) +
  geom_point() #<<
```
]

.right-plot[
![](`r knitr::fig_chunk("mpg-layers-2", "png")`)
]

---

.left-code[
### Add a smooth geom

```{r mpg-layers-3, tidy=FALSE, message=FALSE, fig.show="hide", fig.dim=c(4.8, 5), out.width="100%"}
ggplot(data = mpg,
       mapping = aes(x = displ,
                     y = hwy,
                     color = drv)) +
  geom_point() +
  geom_smooth() #<<
```
]

.right-plot[
![](`r knitr::fig_chunk("mpg-layers-3", "png")`)
]

---

.left-code[
### Make it straight

```{r mpg-layers-4, tidy=FALSE, message=FALSE, fig.show="hide", fig.dim=c(4.8, 5), out.width="100%"}
ggplot(data = mpg,
       mapping = aes(x = displ,
                     y = hwy,
                     color = drv)) +
  geom_point() +
  geom_smooth(method = "lm") #<<
```
]

.right-plot[
![](`r knitr::fig_chunk("mpg-layers-4", "png")`)
]

---

.left-code[
### Use a viridis color scale

```{r mpg-layers-5, tidy=FALSE, message=FALSE, fig.show="hide", fig.dim=c(4.8, 5), out.width="100%"}
ggplot(data = mpg,
       mapping = aes(x = displ,
                     y = hwy,
                     color = drv)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_viridis_d() #<<
```
]

.right-plot[
![](`r knitr::fig_chunk("mpg-layers-5", "png")`)
]

---

.left-code[
### Facet by drive train type

```{r mpg-layers-6, tidy=FALSE, message=FALSE, fig.show="hide", fig.dim=c(4.8, 5), out.width="100%"}
ggplot(data = mpg,
       mapping = aes(x = displ,
                     y = hwy,
                     color = drv)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_viridis_d() +
  facet_wrap(vars(drv), ncol = 1) #<<
```
]

.right-plot[
![](`r knitr::fig_chunk("mpg-layers-6", "png")`)
]

---

.left-code[
### Add labels

```{r mpg-layers-7, tidy=FALSE, message=FALSE, fig.show="hide", fig.dim=c(4.8, 5), out.width="100%"}
ggplot(data = mpg,
       mapping = aes(x = displ,
                     y = hwy,
                     color = drv)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_viridis_d() +
  facet_wrap(vars(drv), ncol = 1) +
  labs(x = "Displacement", y = "Highway MPG",  #<<
       color = "Drive",   #<<
       title = "Larger engines use more fuel",  #<<
       subtitle = "Displacement measures engine size")  #<<
```
]

.right-plot[
![](`r knitr::fig_chunk("mpg-layers-7", "png")`)
]

---

.left-code[
### Add a theme

```{r mpg-layers-8, tidy=FALSE, message=FALSE, fig.show="hide", fig.dim=c(4.8, 5), out.width="100%"}
ggplot(data = mpg,
       mapping = aes(x = displ,
                     y = hwy,
                     color = drv)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_viridis_d() +
  facet_wrap(vars(drv), ncol = 1) +
  labs(x = "Displacement", y = "Highway MPG",
       color = "Drive",
       title = "Larger engines use more fuel",
       subtitle = "Displacement measures engine size") +
  theme_bw() #<<
```
]

.right-plot[
![](`r knitr::fig_chunk("mpg-layers-8", "png")`)
]

---

.left-code[
### Modify the theme

```{r mpg-layers-9, tidy=FALSE, message=FALSE, fig.show="hide", fig.dim=c(4.8, 5), out.width="100%"}
ggplot(data = mpg, 
       mapping = aes(x = displ,
                     y = hwy,
                     color = drv)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_viridis_d() +
  facet_wrap(vars(drv), ncol = 1) +
  labs(x = "Displacement", y = "Highway MPG",
       color = "Drive",
       title = "Larger engines use more fuel",
       subtitle = "Displacement measures engine size") +
  theme_bw() +
  theme(legend.position = "bottom", #<<
        plot.title = element_text(face = "bold")) #<<
```
]

.right-plot[
![](`r knitr::fig_chunk("mpg-layers-9", "png")`)
]

---

.left-code[
### Finished!

```{r mpg-layers-finished, tidy=FALSE, message=FALSE, fig.show="hide", fig.dim=c(4.8, 5), out.width="100%"}
ggplot(data = mpg, 
       mapping = aes(x = displ,
                     y = hwy,
                     color = drv)) +
  geom_point() +
  geom_smooth(method = "lm") + 
  scale_color_viridis_d() +
  facet_wrap(vars(drv), ncol = 1) +
  labs(x = "Displacement", y = "Highway MPG",
       color = "Drive",
       title = "Larger engines use more fuel",
       subtitle = "Displacement measures engine size") +
  theme_bw() +
  theme(legend.position = "bottom",
        plot.title = element_text(face = "bold"))
```
]

.right-plot[
![](`r knitr::fig_chunk("mpg-layers-finished", "png")`)
]


---
class: inverse, center, middle
name: additional-layers

# Reference: Additional layers

---

# Additional layers

.pull-left[
The next several slides contains a preview of additional layers

These are intended as a reference
]

.pull-right[
![](img/07/ggplot-layers@4x.png)
]


---

# Aesthetics

.pull-left-3.center[

`color` (discrete)

```{r aes-color-discrete, echo=FALSE, fig.dim=c(4, 2), out.width="100%"}
eg <- tribble(
  ~x, ~y, ~size, ~x1,
  "A", 1, 5, 1,
  "B", 1, 10, 2,
  "C", 1, 15, 3
)

# Color, discrete
ggplot(eg, aes(x = x, y = y, color = x)) +
  geom_point(size = 30) +
  guides(color = "none") +
  theme(axis.text.y = element_blank(),
        axis.ticks = element_blank())
```

`color` (continuous)

```{r aes-color-continuous, echo=FALSE, fig.dim=c(4, 2), out.width="100%"}
# Color, continuous
ggplot(eg, aes(x = x1, y = y, color = x1)) +
  geom_point(size = 30) +
  guides(color = "none") +
  coord_cartesian(xlim = c(0.5, 3.5)) +
  theme(axis.text.y = element_blank(),
        axis.ticks = element_blank())
```
]

.pull-middle-3.center[

`size`

```{r aes-size, echo=FALSE, fig.dim=c(4, 2), out.width="100%"}
# Size
ggplot(eg, aes(x = x, y = y, size = x)) +
  geom_point() +
  scale_size_discrete(range = c(2, 30)) +
  guides(size = "none") +
  theme(axis.text.y = element_blank(),
        axis.ticks = element_blank())
```

`fill`

```{r aes-fill, echo=FALSE, fig.dim=c(4, 2), out.width="100%"}
# Fill
ggplot(eg, aes(x = x, y = y, fill = x)) +
  geom_point(size = 30, pch = 21, stroke = 5) +
  guides(fill = "none") +
  theme(axis.text.y = element_blank(),
        axis.ticks = element_blank())
```
]

.pull-right-3.center[

`shape`

```{r aes-shape, echo=FALSE, fig.dim=c(4, 2), out.width="100%"}
# Shape
ggplot(eg, aes(x = x, y = y, shape = x)) +
  geom_point(size = 30) +
  guides(shape = "none") +
  theme(axis.text.y = element_blank(),
        axis.ticks = element_blank())
```

`alpha` (opacity)

```{r aes-alpha, echo=FALSE, fig.dim=c(4, 2), out.width="100%"}
# Alpha
ggplot(eg, aes(x = x, y = y, alpha = x)) +
  geom_point(size = 30) +
  guides(alpha = "none") +
  theme(axis.text.y = element_blank(),
        axis.ticks = element_blank())
```
]

---

# Geometries

<table>
  <tr>
    <th class="cell-left"></th>
    <th class="cell-left">Example geometry</th>
    <th class="cell-left">What it makes</th>
  </tr>
  <tr>
    <td class="cell-left"><img src="img/07/geom_bar.png"></td>
    <td class="cell-left"><code class="remark-inline-code">geom_col()</code></td>
    <td class="cell-left">Bar charts</td>
  </tr>
  <tr>
    <td class="cell-left"><img src="img/07/geom_text.png"></td>
    <td class="cell-left"><code class="remark-inline-code">geom_text()</code></td>
    <td class="cell-left">Text</td>
  </tr>
  <tr>
    <td class="cell-left"><img src="img/07/geom_point.png"></td>
    <td class="cell-left"><code class="remark-inline-code">geom_point()</code></td>
    <td class="cell-left">Points</td>
  </tr>
  <tr>
    <td class="cell-left"><img src="img/07/geom_boxplot.png"></td>
    <td class="cell-left"><code class="remark-inline-code">geom_boxplot()</code>&emsp;</td>
    <td class="cell-left">Boxplots</td>
  </tr>
  <tr>
    <td class="cell-left"><img src="img/07/geom_sf.png"></td>
    <td class="cell-left"><code class="remark-inline-code">geom_sf()</code></td>
    <td class="cell-left">Maps</td>
  </tr>
</table>

---

# Geometries

There are dozens of possible geometries

Over the next several weeks we will cover a number of them

See [the **ggplot2** documentation](https://ggplot2.tidyverse.org/reference/index.html#section-layer-geoms) for examples of all the different geometry layers

---

# Scales

Scales change the properties of the variable mapping

<table>
  <tr>
    <th class="cell-left">Example layer</th>
    <th class="cell-left">What it does</th>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">scale_x_continuous()</code></td>
    <td class="cell-left">Make the x-axis continuous</td>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">scale_x_continuous(breaks = 1:5)&ensp;</code></td>
    <td class="cell-left">Manually specify axis ticks</td>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">scale_x_log10()</code></td>
    <td class="cell-left">Log the x-axis</td>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">scale_color_gradient()</code></td>
    <td class="cell-left">Use a gradient</td>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">scale_fill_viridis_d()</code></td>
    <td class="cell-left">Fill with discrete viridis colors</td>
  </tr>
</table>

---

# Scales

.pull-left[

.center[`scale_x_log10()`]

```{r scale-example-1, echo=FALSE, fig.dim=c(4.8, 3.75), out.width="100%"}
gapminder_2007 |> 
  ggplot(aes(x = gdpPercap, y = lifeExp, color = continent, size = pop)) +
  geom_point() +
  scale_x_log10()
```
]

--

.pull-right[

.center[`scale_color_viridis_d()`]

```{r scale-example-2, echo=FALSE, fig.dim=c(4.8, 3.75), out.width="100%"}
ggplot(gapminder_2007, aes(x = gdpPercap, y = lifeExp, color = continent, size = pop)) +
  geom_point() +
  scale_x_log10() +
  scale_color_viridis_d()
```
]

---

# Facets

Facets show subplots for different subsets of data

<table>
  <tr>
    <th class="cell-left">Example layer</th>
    <th class="cell-left">What it does</th>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">facet_wrap(vars(continent))</code></td>
    <td class="cell-left">Plot for each continent</td>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">facet_wrap(vars(continent, year))</code>&emsp;</td>
    <td class="cell-left">Plot for each continent/year</td>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">facet_wrap(..., ncol = 1)</code></td>
    <td class="cell-left">Put all facets in one column</td>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">facet_wrap(..., nrow = 1)</code></td>
    <td class="cell-left">Put all facets in one row</td>
  </tr>
</table>

---

# Facets

.pull-left[

.center.small[`facet_wrap(vars(continent))`]

```{r facet-example-1, echo=FALSE, fig.dim=c(4.8, 3.75), out.width="100%"}
ggplot(gapminder_2007, aes(x = gdpPercap, y = lifeExp, color = continent, size = pop)) +
  geom_point() +
  scale_x_log10() +
  facet_wrap(vars(continent))
```
]

--

.pull-right[

.center.small[`facet_wrap(vars(continent, year))`]

```{r facet-example-2, echo=FALSE, fig.dim=c(4.8, 3.75), out.width="100%"}
ggplot(filter(gapminder, year %in% c(2002, 2007)), 
       aes(x = gdpPercap, y = lifeExp, color = continent, size = pop)) +
  geom_point() +
  scale_x_log10() +
  facet_wrap(vars(year, continent), nrow = 2)
```
]

---

# Coordinates

Change the coordinate system

<table>
  <tr>
    <th class="cell-left">Example layer</th>
    <th class="cell-left">What it does</th>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">coord_cartesian(ylim = c(1, 10))</code>&emsp;</td>
    <td class="cell-left">Zoom in where y is 1–10</td>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">coord_flip()</code></td>
    <td class="cell-left">Switch x and y</td>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">coord_polar()</code></td>
    <td class="cell-left">Use polar coordinates</td>
  </tr>
</table>

---

# Coordinates

.pull-left[

.center.small[`coord_cartesian(ylim = c(70, 80), xlim = c(10000, 30000))`]

```{r coord-example-1, echo=FALSE, fig.dim=c(4.8, 3.25), out.width="100%"}
ggplot(gapminder_2007, aes(x = gdpPercap, y = lifeExp, color = continent, size = pop)) +
  geom_point() +
  scale_x_log10() +
  coord_cartesian(ylim = c(70, 80), xlim = c(10000, 30000))
```
]

--

.pull-right[

.center.small[`coord_flip()`]

```{r coord-example-2, echo=FALSE, fig.dim=c(4.8, 3.75), out.width="100%"}
ggplot(gapminder_2007, aes(x = gdpPercap, y = lifeExp, color = continent, size = pop)) +
  geom_point() +
  scale_x_log10() + 
  coord_flip()
```
]

---

# Labels

Add labels to the plot with a single `labs()` layer

<table>
  <tr>
    <th class="cell-left">Example layer</th>
    <th class="cell-left">What it does</th>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">labs(title = "Neat title")</code></td>
    <td class="cell-left">Title</td>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">labs(caption = "Something")</td>
    <td class="cell-left">Caption</td>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">labs(y = "Something")</td>
    <td class="cell-left">y-axis</td>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">labs(size = "Population")</code></td>
    <td class="cell-left">Title of size legend</td>
  </tr>
</table>

---

# Labels

.left-code[
```{r labels-example, tidy=FALSE, message=FALSE, fig.show="hide", fig.dim=c(4.8, 3.75), out.width="100%"}
gapminder_2007 |> 
  ggplot(aes(x = gdpPercap, y = lifeExp, 
             color = continent, size = pop)) +
  geom_point() +
  scale_x_log10() +
  labs(title = "Health and wealth go together",
       subtitle = "Data from 2007",
       x = "Wealth (GDP per capita)",
       y = "Health (life expectancy)",
       color = "Continent",
       size = "Population",
       caption = "Source: The Gapminder Project")
```
]

.right-plot[
![](`r knitr::fig_chunk("labels-example", "png")`)
]

---

# Theme

`theme()` can be used to change the appearance of anything in a plot

Lots of themes built in and available from other packages

<table>
  <tr>
    <th class="cell-left">Example layer</th>
    <th class="cell-left">What it does</th>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">theme_grey()</code></td>
    <td class="cell-left">Default grey background</td>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">theme_bw()</td>
    <td class="cell-left">Black and white</td>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">theme_dark()</td>
    <td class="cell-left">Dark</td>
  </tr>
  <tr>
    <td class="cell-left"><code class="remark-inline-code">theme_minimal()</code></td>
    <td class="cell-left">Minimal</td>
  </tr>
</table>

---

# Theme

.pull-left[

.center.small[`theme_dark()`]

```{r theme-example-1, echo=FALSE, fig.dim=c(4.8, 3.75), out.width="100%"}
ggplot(gapminder_2007, aes(x = gdpPercap, y = lifeExp, color = continent, size = pop)) +
  geom_point() +
  scale_x_log10() +
  theme_dark()
```
]

--

.pull-right[

.center.small[`theme_minimal()`]

```{r theme-example-2, echo=FALSE, fig.dim=c(4.8, 3.75), out.width="100%"}
ggplot(gapminder_2007, aes(x = gdpPercap, y = lifeExp, color = continent, size = pop)) +
  geom_point() +
  scale_x_log10() + 
  theme_minimal()
```
]

---

# Theme

There are collections of pre-built themes online, like [the **ggthemes** package](https://jrnold.github.io/ggthemes/)

.center[
<figure>
  <img src="img/07/ggthemes.png" alt="ggthemes" title="ggthemes" width="55%">
</figure>
]

---

# Theme

Organizations often make their own custom themes, like [the BBC](https://bbc.github.io/rcookbook/)

.center[
<figure>
  <img src="img/07/bbc-cookbook.png" alt="ggthemes" title="ggthemes" width="80%">
</figure>
]

---

# Theme

Make individual theme adjustments with `theme()`

```{r example-theme-options, eval=FALSE, tidy=FALSE}
theme_bw() + 
theme(legend.position = "bottom",
      plot.title = element_text(face = "bold"),
      panel.grid = element_blank(),
      axis.title.y = element_text(face = "italic"))
```

---

# So many possibilities!

.pull-left[
![](img/07/ggplot-layers@4x.png)
]

.pull-right[
These were just a few examples

See [the **ggplot2** documentation](https://ggplot2.tidyverse.org/reference/index.html) for examples of everything you can do
]







---
class: inverse, center, middle
name: prologue-2

# Prologue

---

# Remember our concentrations?

How might we visualize these amounts?

.less-left[
```{r, echo = FALSE}
load("data/survey-responses/survey-data.RData")
concentrations_tidy <- concentrations |> 
  rename(
    sus = enviro,
    fin = finance,
    oth = other,
    strat = strategy
    ) |>
  select(-degree, -concentration, -program) |>
  summarize_all(sum, na.rm = TRUE) |>
  pivot_longer(everything(), names_to = "concentration", values_to = "count") |>
  arrange(desc(count))
concentrations_tidy
```
]

--

.more-right[
```{r, echo = FALSE}
concentrations_tidy |> 
  ggplot(aes(x = fct_reorder(concentration, -count), y = count)) +
  geom_col() +
  scale_y_continuous(breaks = scales::breaks_pretty()) +
  theme_xaringan(text_font_size = 38) +
  theme(axis.title.y = element_text(size = 40)) +
  labs(x = NULL,
       y = "Number of Concentrators")
```
]

---

# We could do the same thing with sports

```{r, echo = FALSE}
as_tibble(sports) |>
  filter(!is.na(value)) |>
  mutate(value = str_remove(value, " ?\\(.*")) |> 
  ggplot(aes(y = fct_rev(fct_infreq(value)))) +
  geom_bar() +
  scale_x_continuous(breaks = scales::breaks_pretty()) +
  theme_xaringan(text_font_size = 30) +
  theme(axis.title.x = element_text(size = 36)) +
  labs(x = "Number of Fans",
       y = NULL)
```

---

# What are our favorite public companies?

--

```{r, echo = FALSE}
companies |>
  filter(!is.na(name)) |>
  mutate(name = str_to_title(name),
         name = str_replace(name, "\\s?/.*", ""),
         name = str_replace(name, ",?\\s?Inc.?", ""),
         name = str_replace(name, " S\\.a\\.", "")) |> 
  ggplot(aes(y = fct_rev(fct_infreq(name)))) +
  geom_bar() +
  theme_xaringan(text_font_size = 20) +
  theme(axis.title.x = element_text(size = 36)) +
  labs(x = "Number of Potential Investors?",
       y = NULL)
```

---
class: inverse, center, middle
name: amounts

# Amounts

---

# Yay bar plots!

We are a lot better at visualizing line lengths than angles and areas

.pull-left[

```{r example-pie, echo=FALSE, fig.dim=c(4.8, 3), out.width="100%"}
concentrations_tidy |> 
  ggplot(aes(x = "", y = count, fill = concentration)) +
  geom_col() +
  coord_polar(theta = "y") +
  labs(fill = "Concentration") +
  theme_void()
```

]

--

.pull-right[

```{r example-bar, echo=FALSE, fig.dim=c(4.8, 3), out.width="100%"}
concentrations_tidy |> 
  ggplot(aes(x = fct_reorder(concentration, -count), y = count, fill = concentration)) +
  geom_col() +
  scale_y_continuous(breaks = scales::breaks_pretty()) +
  guides(fill = "none") +
  labs(x = "Concentration", y = "Number of Concentrators") +
  theme_minimal()
```

]

---

# Oh no bar plots!

.center[
<figure>
<img src="img/07/obamacareenrollment-fncchart.jpg" alt="Fox News Obamacare enrollment" title="Fox News Obamacare enrollment" width="85%">
</figure>
]

---

# What went wrong?

.center[
<figure>
<img src="img/07/obamacareenrollment-fncchart.jpg" alt="Fox News Obamacare enrollment" title="Fox News Obamacare enrollment" width="85%">
</figure>
]

---

# What went wrong?

.pull-left.center[
<figure>
<img src="img/07/female-height.png" alt="Average female height per country" title="Average female height per country" width="100%">
</figure>
]

--

.pull-right[

**At least two problems:**

1. truncated y axis
2. area scales faster than height

.small[This terrible figure brought to you by a former AEM 2850 / 5850 student!]
]

---

# Bar plots and summary statistics

.pull-left[

```{r animal-weight-bar, echo=FALSE, fig.dim=c(4.8, 3.75), out.width="100%"}
set.seed(1234)
animals <- tibble(animal = c(rep(c("Small cat", "Big cat"), each = 250), rep("Dog", 500))) |>
mutate(weight = case_when(
animal == "Small cat" ~ rnorm(n(), 20, 5),
animal == "Big cat" ~ rnorm(n(), 60, 5),
animal == "Dog" ~ rnorm(n(), 40, 10)
)) |>
mutate(animal_type = ifelse(str_detect(animal, "cat"), "Cats", "Dogs"))

animals_mean <- animals |>
group_by(animal_type) |>
summarize(avg_weight = mean(weight))

ggplot(animals_mean, aes(x = animal_type, y = avg_weight, fill = animal_type)) +
geom_col() +
labs(x = NULL, y = "Average Weight") +
ylim(0, 75) +
guides(fill = "none")
```

]

--

.pull-right[

```{r animal-weight-points, echo=FALSE, fig.dim=c(4.8, 3.75), out.width="100%"}
animals |> 
  ggplot(aes(x = animal_type,
             y = weight,
             color = animal_type)) +
  geom_point(position = position_jitter(), #<<
             size = 1, #<<
             alpha = 0.5) + #<<
  labs(x = NULL, y = "Weight") +
  guides(color = "none")
```

]

---

# General rules for bar charts

Useful when the length of the bar is all that matters

--

Bar charts should always start at zero
- Or: don't use bars!

--

Don't use bars for summary statistics. You throw away too much information.
- We will come back to visualizing distributions / uncertainty next week


---
class: inverse, center, middle
name: plotting-amounts

# Plotting amounts using ggplot

---

# Plotting amounts using ggplot

We'll use a summarized version of the gapminder dataset for examples

```{r }
library(gapminder)
gapminder_continents <- gapminder |>
  filter(year == 2007) |>  # only look at 2007
  count(continent) |>      # count the number of countries per continent
  arrange(desc(n))         # sort by count, descending
gapminder_continents
```

---

# Start with a simple bar plot

.left-code.small-code[

```{r gapminder-bars, fig.show="hide", tidy=FALSE, message=FALSE, fig.dim=c(4.8, 3.5), out.width="100%"}
gapminder_continents |> 
  ggplot(aes(x = continent, # continent to x
             y = n)) +      # n countries to y
  geom_col()                # add bars #<<
```
How could we improve this?
]

.right-plot[

![](`r knitr::fig_chunk("gapminder-bars", "png")`)

]

---

# Add some color

.left-code.small-code[

```{r gapminder-bars-colored-legend, fig.show="hide", tidy=FALSE, message=FALSE, fig.dim=c(4.8, 3.5), out.width="100%"}
gapminder_continents |> 
  ggplot(aes(x = continent, 
             y = n,
             fill = continent)) + # color bars #<<
  geom_col()
```

Do we need the fill legend?
]

.right-plot[

![](`r knitr::fig_chunk("gapminder-bars-colored-legend", "png")`)

]

---

# Add some color

.left-code.small-code[

```{r gapminder-bars-colored, fig.show="hide", tidy=FALSE, message=FALSE, fig.dim=c(4.8, 3.5), out.width="100%"}
gapminder_continents |> 
  ggplot(aes(x = continent, y = n,
             fill = continent)) +
  geom_col() +
  guides(fill = "none") # omit fill legend #<<
```

Is "n" a good axis title?

Do we need "continent" at all?
]

.right-plot[

![](`r knitr::fig_chunk("gapminder-bars-colored", "png")`)

]

---

# Add some labels

.left-code.small-code[

```{r gapminder-bars-labeled, fig.show="hide", tidy=FALSE, message=FALSE, fig.dim=c(4.8, 3.5), out.width="100%"}
gapminder_continents |> 
  ggplot(aes(x = continent, y = n,
             fill = continent)) +
  geom_col() +
  guides(fill = "none") +
  labs(x = NULL, y = "Number of countries") #<<
```

Is alphabetical the best ordering?
]

.right-plot[

![](`r knitr::fig_chunk("gapminder-bars-labeled", "png")`)

]

---

# Order by data value

.left-code.small-code[

```{r gapminder-bars-ordered, fig.show="hide", tidy=FALSE, message=FALSE, fig.dim=c(4.8, 3.5), out.width="100%"}
gapminder_continents |> 
  ggplot(aes(x = fct_reorder(continent, n),  #<<
             y = n, fill = continent)) +
  geom_col() +
  guides(fill = "none") +
  labs(x = NULL, y = "Number of countries")
```

`fct_reorder(continent, n)` means "reorder the factor variable continent by n, smallest to largest"

Factor is R's term for variables that have a fixed and known set of possible values
]

.right-plot[

![](`r knitr::fig_chunk("gapminder-bars-ordered", "png")`)

]

---

# Order by data value, descending

.left-code.small-code[

```{r gapminder-bars-reversed, fig.show="hide", tidy=FALSE, message=FALSE, fig.dim=c(4.8, 3.5), out.width="100%"}
gapminder_continents |> 
  ggplot(aes(x = fct_reorder(continent, -n), #<<
             y = n, fill = continent)) +
  geom_col() +
  guides(fill = "none") +
  labs(x = NULL, y = "Number of countries")
```

`fct_reorder(continent, -n)` means "reorder the factor variable continent by n, largest to smallest"
]

.right-plot[

![](`r knitr::fig_chunk("gapminder-bars-reversed", "png")`)

]

---

# Another option is to encode order in the data

.left-code.small-code[

```{r gapminder-bars-fct_inorder, fig.show="hide", tidy=FALSE, message=FALSE, fig.dim=c(4.8, 3.5), out.width="100%"}
# use `fct_inorder` to order levels of continent
# based on how they appear in the data
gapminder_ordered <- gapminder_continents |>
  arrange(desc(n)) |> # sort by count, descending
  mutate(continent = fct_inorder(continent)) #<<
gapminder_ordered |> 
  ggplot(aes(x = continent, #<<
             y = n, 
             fill = continent)) +
  geom_col() +
  guides(fill = "none") +
  labs(x = NULL, y = "Number of countries")
```
]

.right-plot[

![](`r knitr::fig_chunk("gapminder-bars-fct_inorder", "png")`)

]

---

# Wait, what about geom_bar?

Use `geom_bar` to count and plot in one step

.left-code[

```{r geom_bar, fig.show="hide", tidy=FALSE, message=FALSE, fig.dim=c(4.8, 3.5), out.width="100%"}
gapminder |> # old data: rows are countries #<<
  filter(year == 2007) |>
  ggplot(aes(x = continent, # note: no y aesthetic defined
             fill = continent)) +
  geom_bar() + #<<
  guides(fill = "none") +
  labs(x = NULL, y = "Number of countries")
```
]

.right-plot[

![](`r knitr::fig_chunk("geom_bar", "png")`)

]

---

# Wait, what about geom_bar?

Here we can reorder by frequency using `fct_infreq`

.left-code[

```{r geom_bar-ordered, fig.show="hide", tidy=FALSE, message=FALSE, fig.dim=c(4.8, 3.5), out.width="100%"}
gapminder |>
  filter(year == 2007) |>
  ggplot(aes(x = fct_infreq(continent), #<<
             fill = continent)) +
  geom_bar() +
  guides(fill = "none") +
  labs(x = NULL, y = "Number of countries")
```
]

.right-plot[

![](`r knitr::fig_chunk("geom_bar-ordered", "png")`)

]

---

# We can also flip geom_col/bar axes

Simply use `y = ` instead of `x = ` for the aesthetic mapping

.left-code[

```{r geom_bar-y, fig.show="hide", tidy=FALSE, message=FALSE, fig.dim=c(4.8, 3.5), out.width="100%"}
gapminder |>
  filter(year == 2007) |>
  ggplot(aes(y = fct_infreq(continent), #<<
             fill = continent)) +
  geom_bar() +
  guides(fill = "none") +
  labs(x = "Number of countries", y = NULL) #<<
```
]

.right-plot[

![](`r knitr::fig_chunk("geom_bar-y", "png")`)

]

---

# We can also flip geom_col/bar axes

`fct_rev()` reverses the order of factors

.left-code[

```{r geom_bar-y-rev, fig.show="hide", tidy=FALSE, message=FALSE, fig.dim=c(4.8, 3.5), out.width="100%"}
gapminder |>
  filter(year == 2007) |>
  ggplot(aes(y = fct_rev(fct_infreq(continent)), #<<
             fill = continent)) +
  geom_bar() +
  guides(fill = "none") +
  labs(x = "Number of countries", y = NULL)
```
]

.right-plot[

![](`r knitr::fig_chunk("geom_bar-y-rev", "png")`)

]

---

# Grouped bar charts

Use grouped bars or facets for higher dimensional datasets

.left-code[
```{r geom_bar-grouped, fig.show="hide", tidy=FALSE, message=FALSE, fig.dim=c(4.8, 3.5), out.width="100%"}
gapminder |>
  filter(year==1957 | year==2007) |> 
  group_by(continent, year) |> 
  summarize(
    lifeExp = sum(lifeExp * pop) / sum(pop)
  ) |> 
  ggplot(aes(x = continent,
             y = lifeExp,
             fill = as_factor(year))) + #<<
  geom_col(position = "dodge") + #<<
  labs(x = NULL, 
       y = "Life expectancy", fill = "Year")
```
`as_factor()` specifies that we want to treat `year` as distinct categories, not a continuous measure
]

.right-plot[

![](`r knitr::fig_chunk("geom_bar-grouped", "png")`)

]

---

# Facets

Use grouped bars or facets for higher dimensional datasets

.left-code[
```{r geom_bar-faceted, fig.show="hide", tidy=FALSE, message=FALSE, fig.dim=c(4.8, 3.5), out.width="100%"}
gapminder |>
  filter(year==1957 | year==2007) |> 
  group_by(continent, year) |> 
  summarize(
    lifeExp = sum(lifeExp * pop) / sum(pop)
  ) |> 
  ggplot(aes(x = continent,
             y = lifeExp,
             fill = as_factor(year))) + 
  geom_col() + #<<
  facet_wrap(vars(year)) + #<<
  guides(fill = "none") +
  labs(x = NULL, 
       y = "Life expectancy")
```
]

.right-plot[

![](`r knitr::fig_chunk("geom_bar-faceted", "png")`)

]

---

# Alternative: Dots instead of bars

Dots are preferable if we want to truncate the axes

.left-code[

```{r dots, fig.show="hide", tidy=FALSE, message=FALSE, fig.dim=c(4.8, 3.5), out.width="100%"}
gapminder |>
  filter(year == 2007, continent == "Americas") |>
  ggplot(aes(x = lifeExp,
             y = fct_reorder(country, lifeExp))) +
  geom_point() + #<<
  guides(color = "none") +
  labs(x = "Life expectancy (years)", y = NULL) +
  theme_minimal()
```
]

.right-plot[

![](`r knitr::fig_chunk("dots", "png")`)

]

---
class: inverse, center, middle
name: example-2

# example-07-2:<br>amounts-practice.R

